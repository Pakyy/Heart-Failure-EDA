---
title: "Data Visualization Exam"
author: "Pasquale Gravante & Antonio Mastroianni"
date: "2022-10-24"
output: 
  html_document:
    df_print: paged
    code_folding: hide
---

The dataset consists of data regarding a sample consisting of  **299 patients** possibly affected by cardiovascular deseases.
The variables taken into account for the analysis are:

*   **Age**: integer representing the age of the patient
*   **Sex**: sex of the patient **(Boolean)**
*   **Anaemia**: decrease of red blood cells or hemoglobin **(Boolean)**
*   **Creatinine_phosphokinase**: level of the CPK enzyme in the blood **(mcg/L)**
*   **Diabetes**: whether the patient has diabetes **(Boolean)**
*   **Ejection_fraction**: Percentage of blood leaving the heart at each contraction
*   **high_blood_pressure**: whether the patient suffers from hypertension
*   **Platelets**: Platelets in the blood **(kiloplatelets/mL)*
*   **serum_creatinine**: Level of serum creatinine in the blood **(mg/dL)**
*   **serum_sodium**: Level of serum sodium in the blood **(mEq/L)**
*   **Smoking**: If the patient smokes or not **(Boolean)**
*   **Time**: Follow-up period **(days)**
*   **Death_event**: If the patient died for a cardiac arrest or not **(Boolean)**

```{r Libraries, echo=TRUE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(tidyr)
library(gridExtra)
library(GGally)
library(moments)
library(corrplot)
```

```{r}
heart <- read.csv("~/Downloads/heart_failure_clinical_records_dataset.csv")
glimpse(heart)
```

```{r Editing column type}
for (i in c(2,4,6,13)){
  heart[,i] = as.factor(heart[,i])
}
heart$sex[heart$sex==0] <- 'Female'
heart$sex[heart$sex==1] <- 'Male'
heart$smoking[heart$smoking==0] <- 'No'
heart$smoking[heart$smoking==1] <- 'Yes'
heart$sex = as.factor(heart$sex)
heart$smoking = as.factor(heart$smoking)
glimpse(heart)
```

```{r}
data.frame(unclass(summary(heart[,-c(2,4,6,10,11,13)])), check.names = FALSE, stringsAsFactors = FALSE)
```

```{r Age histogram}
ggplot(heart, aes(x = age)) +
  geom_histogram(aes(y = ..density..), binwidth = 10, fill = 'cyan3', color = 'white') +
  theme_minimal() + 
  geom_vline(xintercept = mean(heart$age), color = 'deeppink2') +
  labs(x = 'Age', y='Density')+
  scale_x_continuous(breaks= c(35, 45,55,65,75,85,95))
```

```{r Central Tendency}
ggplot(heart, aes(x = creatinine_phosphokinase, color = sex))+
  stat_ecdf()+
  labs(x = 'CPK', y='F(CPK)')
sex <- c('Male','Female')
mean <- c(mean(filter(heart, sex == 'Male')$creatinine_phosphokinase),mean(filter(heart, sex == 'Female')$creatinine_phosphokinase))
median <- c(median(filter(heart, sex == 'Male')$creatinine_phosphokinase),median(filter(heart, sex == 'Female')$creatinine_phosphokinase)
)
data.frame(sex, mean, median)
```

```{r}
ggplot(heart, aes(x = creatinine_phosphokinase)) +
  geom_histogram(aes(y = ..density..), binwidth = 100, fill = 'cyan3', color = 'white') +
  theme_minimal() + 
  geom_vline(xintercept = mean(heart$creatinine_phosphokinase), color = 'deeppink2') +
  geom_vline(xintercept = median(heart$creatinine_phosphokinase), color = 'purple') +
  labs(x = 'CPK', y='Density')
```

```{r Variability measures}
attach(heart)
var <- c(var(filter(heart, sex == 'Male')$creatinine_phosphokinase),
var(filter(heart, sex == 'Female')$creatinine_phosphokinase))
sd <- c(sd(filter(heart, sex == 'Male')$creatinine_phosphokinase),
sd(filter(heart, sex == 'Female')$creatinine_phosphokinase))
diff <- c(diff(range(filter(heart, sex == 'Male')$creatinine_phosphokinase)),
diff(range(filter(heart, sex == 'Female')$creatinine_phosphokinase)))
interquartile_range <- function(x){
diff(quantile(x, probs = c(0.25, 0.75)))
}
iq <- c(interquartile_range(filter(heart, sex == 'Male')$creatinine_phosphokinase),
interquartile_range(filter(heart, sex == 'Female')$creatinine_phosphokinase))
MAD <- function(x) {
median(abs(x - median(x)))
}
mad <- c(MAD(filter(heart, sex == 'Male')$creatinine_phosphokinase),
MAD(filter(heart, sex == 'Female')$creatinine_phosphokinase))
data.frame(sex, var, sd, diff, iq, mad)
```


```{r Boxplots in base al sesso}
options(scipen = 999)
bp1 = ggplot(heart, aes(x = sex, y = serum_creatinine, fill = sex)) + geom_boxplot() 
bp2 = ggplot(heart, aes(x = sex, y = creatinine_phosphokinase, fill = sex)) + geom_boxplot() 
bp3 = ggplot(heart, aes(x = sex, y = platelets, fill = sex)) + geom_boxplot() 
bp4 = ggplot(heart, aes(x = sex, y = ejection_fraction, fill = sex)) + geom_boxplot() 
grid.arrange(bp1,bp2,bp3,bp4, nrow = 2)
```

```{r Boxplots fumatori}
bp5 = ggplot(heart, aes(x = smoking, y = serum_creatinine, fill = smoking)) + geom_boxplot() 
bp6 = ggplot(heart, aes(x = smoking, y = creatinine_phosphokinase, fill = smoking)) + geom_boxplot() 
bp7 = ggplot(heart, aes(x = smoking, y = platelets, fill = smoking)) + geom_boxplot() 
bp8 = ggplot(heart, aes(x = smoking, y = ejection_fraction, fill = smoking)) + geom_boxplot() 
grid.arrange(bp5,bp6,bp7,bp8, nrow = 2)
```

```{r Boxplots diabetici}
bp9 = ggplot(heart, aes(x = diabetes, y = serum_creatinine, fill = diabetes)) + geom_boxplot() 
bp10 = ggplot(heart, aes(x = diabetes, y = creatinine_phosphokinase, fill = diabetes)) + geom_boxplot() 
bp11 = ggplot(heart, aes(x = diabetes, y = platelets, fill = diabetes)) + geom_boxplot() 
bp12 = ggplot(heart, aes(x = diabetes, y = ejection_fraction, fill = diabetes)) + geom_boxplot()
grid.arrange(bp9,bp10,bp11,bp12, nrow = 2)
```

```{r 3rd and 4th moment }
heart$cpk_standard <- scale(heart$creatinine_phosphokinase)
mean(heart$cpk_standard)
d1 <- ggplot(filter(heart, sex == 'Male'), aes(x= cpk_standard, color = sex ))+
  geom_density(color = '#6dca7c')+
  labs(x='CPK')+
  theme_bw()+
    scale_x_continuous(breaks= c(-1,0,1,2,3,4,5,6,7))
d2 <- ggplot(filter(heart, sex == 'Female'), aes(x= cpk_standard ))+
  geom_density(color = '#933183')+
  labs(x='CPK')+
  theme_bw()+
  scale_x_continuous(breaks= c(-1,0,1,2,3,4))
grid.arrange(d1, d2)
#add labels
skew <- c(skewness(filter(heart, sex == 'Male')$creatinine_phosphokinase), skewness(filter(heart, sex == 'Female')$creatinine_phosphokinase))
kurt <- c(kurtosis(filter(heart, sex == 'Male')$creatinine_phosphokinase), kurtosis(filter(heart, sex == 'Female')$creatinine_phosphokinase))
data.frame(sex, skew, kurt)
```

In order to understand which variables might be related a paired scatterplot is represented.

```{r Paired Scatterplot}
ggpairs(heart, columns = c(1,3,5,7,8,9), aes(color = sex), diag = list(continuous = 'blankDiag'), upper = list(continuous = 'points'))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 0.5))
```


```{r Contingency table and chi-square}
classes = cut(heart$ejection_fraction, c(14, 30, 45, 80))
classes = as.character(classes)
heart$ejection_fraction_classes = classes
heart$ejection_fraction_classes[heart$ejection_fraction_classes == "(14,30]"] = "Low"
heart$ejection_fraction_classes[heart$ejection_fraction_classes == "(30,45]"] = "Medium"
heart$ejection_fraction_classes[heart$ejection_fraction_classes == "(45,80]"] = "High"
heart$ejection_fraction_classes = as.factor(heart$ejection_fraction_classes)
ft1 = ftable(heart$sex, heart$ejection_fraction_classes, heart$DEATH_EVENT)
ft1
chisq = chisq.test(ft1)
chisq.test(ft1)
chisq$residuals
```

```{r QUalitative Variables - Barplot}
  
ggplot(heart, aes(x = smoking, fill = sex))+
  geom_bar()+
  labs(x = 'Smoking', y='Frequency', title = 'Total of smoking males and females')
```

```{r Gini index}
#se c'Ã¨ tempo
```


In order to understand which variables might be related a paired scatterplot is represented.

Apparently, there is not any relation between variables. 
Let's get a look at the numbers to check if this is true. 

```{r Variance covariance matrix}
as.data.frame(cov(heart[,c(1,3,5,7,8,9)]))
```

The correlationplot shows the absence of strong correlations between the variables taken into account. 

In order to understand which variables might be related a paired scatterplot is represented.

```{r Paired Scatterplots}
ggpairs(heart, columns = c(1,3,5,7,8,9), aes(color = sex), diag = list(continuous = 'blankDiag'), upper = list(continuous = 'points'))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 0.5))
```

Scatters are colored according to "sex" variable. Apparently, there is not any relation between variables. 
Let's get a look at the numbers to check if this is true. 


```{r Correlation matrix}
corrplot(cor(heart[,c(1,3,5,7,8,9)]), method = 'color', addCoef.col = '#4d4c4b', order ='AOE', diag = FALSE, cl.cex = 0.5, tl.col='Black', tl.cex=0.8, tl.srt=70 ,)
```

The correlationplot shows the absence of strong correlations between the variables taken into account.
THe highest(negative) correlation value is between 'serum_creatinine' and 'serum_sodium'.

Let's give a look at the regression line for these two variables. 


```{r Linear Regression}
ggplot(heart, aes(x = serum_sodium, y = serum_creatinine, color = sex))+
  geom_point()+
  geom_smooth(method="lm", se = FALSE, color = 'deeppink3')
```


```{r Parameters}
reg <-lm(formula = heart$serum_creatinine ~ heart$serum_sodium)
as.data.frame(reg$coefficients)
```


While the goodness of fitness is equal to:
```{r Goodness of fitness}
cor(heart$serum_creatinine, heart$serum_sodium)^2
```
R^2 value is very low. Only 3.5% of the total variability of the data is explained by the displayed regression model.

Let's take into account the CPK concentration variable. We want to know, based on the observations in the sample, what is the confidence interval containing the mean of the population.

We are going to perform a t-test because the variance of the population is not known.
We are going to consider a confidence level of 0.99

```{r Confidence Intervals}
t.test(heart$creatinine_phosphokinase, alternative = "two.sided", conf.level = 0.99)
```

The mean of the population resides in the interval [436.37; 727.30] with a confidence level of 0.99.

Let's assume to reduce our confidence level to 0.95.

```{r}
t.test(heart$creatinine_phosphokinase, alternative = "two.sided", conf.level = 0.95)

```

As expected, the confidence interval narrows as the confidence level decreases.


Let's also assume the case in which the analyzed sample has a smaller dimension.
In order to do that, we are going to sample without replacement our data and get 150 observation.

```{r Bootstrap Confidence interval}
h <- sample(heart$creatinine_phosphokinase, 150, replace = FALSE)
t.test(h, alternative = "two.sided", conf.level = 0.95)


```
As expected, when the sample dimension is reduced, the confidence interval increases.

# Anova

```{r}
attach(heart)
plot(creatinine_phosphokinase~ejection_fraction_classes)
plot.design(creatinine_phosphokinase~ejection_fraction_classes)
plot.design(creatinine_phosphokinase~ejection_fraction_classes, fun = median)
```

```{r}
par(mfrow=c(2,2))
qqnorm(creatinine_phosphokinase[ejection_fraction_classes=="Low"])
qqline(creatinine_phosphokinase[ejection_fraction_classes=="Low"])
qqnorm(creatinine_phosphokinase[ejection_fraction_classes=="Medium"])
qqline(creatinine_phosphokinase[ejection_fraction_classes=="Medium"])
qqnorm(creatinine_phosphokinase[ejection_fraction_classes=="High"])
qqline(creatinine_phosphokinase[ejection_fraction_classes=="High"])
```

```{r}
oneway.test(creatinine_phosphokinase~ejection_fraction_classes, var.equal = TRUE)
```
